"use strict";function logerror(t){"test"!==this.get("env")&&console.error(t.stack||t.toString())}function tryRender(t,e,n){try{t.render(e,n)}catch(r){n(r)}}var finalhandler=require("finalhandler"),Router=require("./router"),methods=require("methods"),middleware=require("./middleware/init"),query=require("./middleware/query"),debug=require("debug")("express:application"),View=require("./view"),http=require("http"),compileETag=require("./utils").compileETag,compileQueryParser=require("./utils").compileQueryParser,compileTrust=require("./utils").compileTrust,deprecate=require("depd")("express"),flatten=require("array-flatten"),merge=require("utils-merge"),resolve=require("path").resolve,setPrototypeOf=require("setprototypeof"),slice=Array.prototype.slice,app=exports=module.exports={},trustProxyDefaultSymbol="@@symbol:trust_proxy_default";app.init=function(){this.cache={},this.engines={},this.settings={},this.defaultConfiguration()},app.defaultConfiguration=function(){var t=process.env.NODE_ENV||"development";this.enable("x-powered-by"),this.set("etag","weak"),this.set("env",t),this.set("query parser","extended"),this.set("subdomain offset",2),this.set("trust proxy",!1),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!0}),debug("booting in %s mode",t),this.on("mount",function(t){this.settings[trustProxyDefaultSymbol]===!0&&"function"==typeof t.settings["trust proxy fn"]&&(delete this.settings["trust proxy"],delete this.settings["trust proxy fn"]),setPrototypeOf(this.request,t.request),setPrototypeOf(this.response,t.response),setPrototypeOf(this.engines,t.engines),setPrototypeOf(this.settings,t.settings)}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",View),this.set("views",resolve("views")),this.set("jsonp callback name","callback"),"production"===t&&this.enable("view cache"),Object.defineProperty(this,"router",{get:function(){throw new Error("'app.router' is deprecated!\nPlease see the 3.x to 4.x migration guide for details on how to update your app.")}})},app.lazyrouter=function(){this._router||(this._router=new Router({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")}),this._router.use(query(this.get("query parser fn"))),this._router.use(middleware.init(this)))},app.handle=function(t,e,n){var r=this._router,i=n||finalhandler(t,e,{env:this.get("env"),onerror:logerror.bind(this)});return r?void r.handle(t,e,i):(debug("no routes defined on app"),void i())},app.use=function(t){var e=0,n="/";if("function"!=typeof t){for(var r=t;Array.isArray(r)&&0!==r.length;)r=r[0];"function"!=typeof r&&(e=1,n=t)}var i=flatten(slice.call(arguments,e));if(0===i.length)throw new TypeError("app.use() requires middleware functions");this.lazyrouter();var o=this._router;return i.forEach(function(t){return t&&t.handle&&t.set?(debug(".use app under %s",n),t.mountpath=n,t.parent=this,o.use(n,function(e,n,r){var i=e.app;t.handle(e,n,function(t){setPrototypeOf(e,i.request),setPrototypeOf(n,i.response),r(t)})}),void t.emit("mount",this)):o.use(n,t)},this),this},app.route=function(t){return this.lazyrouter(),this._router.route(t)},app.engine=function(t,e){if("function"!=typeof e)throw new Error("callback function required");var n="."!==t[0]?"."+t:t;return this.engines[n]=e,this},app.param=function(t,e){if(this.lazyrouter(),Array.isArray(t)){for(var n=0;n<t.length;n++)this.param(t[n],e);return this}return this._router.param(t,e),this},app.set=function(t,e){if(1===arguments.length)return this.settings[t];switch(debug('set "%s" to %o',t,e),this.settings[t]=e,t){case"etag":this.set("etag fn",compileETag(e));break;case"query parser":this.set("query parser fn",compileQueryParser(e));break;case"trust proxy":this.set("trust proxy fn",compileTrust(e)),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!1})}return this},app.path=function(){return this.parent?this.parent.path()+this.mountpath:""},app.enabled=function(t){return Boolean(this.set(t))},app.disabled=function(t){return!this.set(t)},app.enable=function(t){return this.set(t,!0)},app.disable=function(t){return this.set(t,!1)},methods.forEach(function(t){app[t]=function(e){if("get"===t&&1===arguments.length)return this.set(e);this.lazyrouter();var n=this._router.route(e);return n[t].apply(n,slice.call(arguments,1)),this}}),app.all=function(t){this.lazyrouter();for(var e=this._router.route(t),n=slice.call(arguments,1),r=0;r<methods.length;r++)e[methods[r]].apply(e,n);return this},app.del=deprecate["function"](app["delete"],"app.del: Use app.delete instead"),app.render=function(t,e,n){var r,i=this.cache,o=n,s=this.engines,a=e,u={};if("function"==typeof e&&(o=e,a={}),merge(u,this.locals),a._locals&&merge(u,a._locals),merge(u,a),null==u.cache&&(u.cache=this.enabled("view cache")),u.cache&&(r=i[t]),!r){var l=this.get("view");if(r=new l(t,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:s}),!r.path){var c=Array.isArray(r.root)&&r.root.length>1?'directories "'+r.root.slice(0,-1).join('", "')+'" or "'+r.root[r.root.length-1]+'"':'directory "'+r.root+'"',d=new Error('Failed to lookup view "'+t+'" in views '+c);return d.view=r,o(d)}u.cache&&(i[t]=r)}tryRender(r,u,o)},app.listen=function(){var t=http.createServer(this);return t.listen.apply(t,arguments)};